<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_5.4.xsd">

  <grid name="sale-order-grid" title="Sale orders" model="com.axelor.sale.db.SaleOrder">
    <field name="saleOrderSeq"/>
    <field name="statusSelect"/>
    <field name="clientPartner"/>
    <field name="finalizationDateT"/>
    <field name="finalizedBy"/>
    <field name="confirmationDateT"/>
    <field name="confirmedBy"/>
    <field name="totalPrice"/>
  </grid>


  <form name="sale-order-form" title="Sale order" model="com.axelor.sale.db.SaleOrder"
    width="large" onSave="action-sale-order-validate-total-price">

    <panel name="mainPanel" itemSpan="4">
      <field name="statusSelect" colSpan="12" widget="nav-select" readonly="true"/>
      <field name="saleOrderSeq"/>
      <field name="clientPartner" grid-view="partner-grid" form-view="partner-form"/>
      <field name="totalPrice" readonly="true"/>
      <field name="saleOrderLineList" grid-view="sale-order-line-grid"
        form-view="sale-order-line-form" colSpan="12"/>
      <field name="comments" colSpan="12"/>
    </panel>

    <panel name="invoicesPanel" title="Invoices" itemSpan="12"
      showIf="invoiceSet != null &amp;&amp; invoiceSet.length &gt; 0">

      <field name="invoiceSet" grid-view="invoice-grid" form-view="invoice-form"
        showTitle="false" canNew="false" canRemove="false" canSelect="false" edit-window="blank"/>
    </panel>

    <panel name="actionsPanel" sidebar="true">

      <button name="editTotalPriceBtn" title="Edit total price" css="btn-custom"
        onClick="action-sale-order-attrs-make-total-price-editable" showIf="statusSelect != 20"/>

      <button name="finalizeBtn" title="Finalize" onClick="action-sale-order-record-finalize"
        showIf="statusSelect == 0"/>
      <button name="confirmBtn" title="Confirm" onClick="action-sale-order-group-confirm"
        showIf="statusSelect == 10"/>
      <button name="cancelBtn" title="Cancel" onClick="action-sale-order-record-cancel"
        showIf="statusSelect == 20" css="btn-danger"/>
      <button name="backToDraftButton" title="Back to draft"
        onClick="action-sale-order-record-draft" showIf="statusSelect == -10"/>
    </panel>

    <panel name="followupPanel" title="Follow up" showIf="id" sidebar="true">
      <field name="createdOn"/>
      <field name="createdBy"/>
      <field name="finalizationDateT" showIf="finalizationDateT"/>
      <field name="finalizedBy" showIf="finalizedBy"/>
      <field name="confirmationDateT" showIf="confirmationDateT"/>
      <field name="confirmedBy" showIf="confirmedBy"/>
    </panel>

  </form>


  <action-validate name="action-sale-order-validate-total-price">
    <alert message="The total price is 0." if="eval: totalPrice == 0"/>
  </action-validate>


  <action-attrs name="action-sale-order-attrs-make-total-price-editable">
    <attribute name="readonly" for="totalPrice" expr="false"/>
  </action-attrs>


  <action-record name="action-sale-order-record-finalize"
    model="com.axelor.sale.db.SaleOrder">
    <field name="statusSelect" expr="eval: __repo__(SaleOrder).STATUS_FINALIZED"/>
    <field name="finalizationDateT" expr="eval: __time__"/>
    <field name="finalizedBy" expr="eval: __user__"/>
  </action-record>

  <action-group name="action-sale-order-group-confirm">
    <action name="action-sale-order-validate-warn-same-user-from-finalisation"
      if="eval: __user__.equals(finalizedBy)"/>
    <action name="action-sale-order-record-confirm"/>
  </action-group>

  <action-validate
    name="action-sale-order-validate-warn-same-user-from-finalisation">
    <alert
      message="You already finalized this sale order. By confirming it yourself you will skip the double validation. Continue?"/>
  </action-validate>

  <action-record name="action-sale-order-record-confirm"
    model="com.axelor.sale.db.SaleOrder">
    <field name="statusSelect" expr="eval: __repo__(SaleOrder).STATUS_CONFIRMED"/>
    <field name="confirmationDateT" expr="eval: __time__"/>
    <field name="confirmedBy" expr="eval: __user__"/>
  </action-record>

  <action-record name="action-sale-order-record-cancel"
    model="com.axelor.sale.db.SaleOrder">
    <field name="statusSelect" expr="eval: __repo__(SaleOrder).STATUS_CANCELLED"/>
    <field name="finalizationDateT" expr="eval: null"/>
    <field name="finalizedBy" expr="eval: null"/>
    <field name="confirmationDateT" expr="eval: null"/>
    <field name="confirmedBy" expr="eval: null"/>
  </action-record>

  <action-record name="action-sale-order-record-draft"
    model="com.axelor.sale.db.SaleOrder">
    <field name="statusSelect" expr="eval: __repo__(SaleOrder).STATUS_DRAFT"/>
  </action-record>

</object-views>
